{% extends 'base.html' %}

{% block title %}ML - Análise ENEM 2024{% endblock %}

{% block content %}

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
    .filter-buttons {
        display: flex;
        flex-wrap: wrap; 
        justify-content: center;
    }
    .filter-buttons a {
        background-color: var(--cor-secundaria);
        color: var(--cor-texto-sec);
        border: 1px solid var(--cor-destaque);
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    .filter-buttons a:hover,
    .filter-buttons a.active {
        background-color: var(--cor-destaque);
        color: var(--cor-primaria);
        font-weight: 700;
        box-shadow: 0 0 10px var(--cor-destaque);
    }
    
    .plotly-chart-div {
        min-height: 450px;
    }

</style>

<div class="card">
    <h1>Análise Preditiva</h1>
    <p>
        Para tentar prever a nota de um aluno, aplicamos o modelo de 
        Aprendizado de Máquina <em>Random Forest Regressor</em>
    </p>
</div>

<div class="card">
    <h2>Filtro de Matéria</h2>
    <p>Selecione uma matéria para treinar o modelo e ver os resultados:</p>
    <div class="filter-buttons">
        <a href="/aprendizado-maquina?materia=mt" 
           class="{% if materia_ativa == 'mt' %}active{% endif %}">
           Matemática
        </a>
        <a href="/aprendizado-maquina?materia=red" 
           class="{% if materia_ativa == 'red' %}active{% endif %}">
           Redação
        </a>
        <a href="/aprendizado-maquina?materia=lc" 
           class="{% if materia_ativa == 'lc' %}active{% endif %}">
           Linguagens
        </a>
        <a href="/aprendizado-maquina?materia=ch" 
           class="{% if materia_ativa == 'ch' %}active{% endif %}">
           Humanas
        </a>
        <a href="/aprendizado-maquina?materia=cn" 
           class="{% if materia_ativa == 'cn' %}active{% endif %}">
           Natureza
        </a>
    </div>
</div>

<div class="card kpi-card">
    <h3 class="kpi-title">
        Score R² (Capacidade de Explicação) para {{ materia_ativa.upper() }}
    </h3>
    <div class="kpi-value">
        {{ ml_score }}%
    </div>
    <p class="kpi-title">
        Isto significa que o modelo, usando apenas os fatores 
        "Tipo de Escola" e "Localização", consegue explicar 
        <strong>{{ ml_score }}%</strong> da variação das notas
    </p>
</div>

<div class="card">
    <h2>Importância das Variáveis</h2>
    <p>Qual fator tem mais "peso" para definir a nota? (Soma total = 1.0)</p>
    <div id="importance-chart" class="plotly-chart-div"></div>
</div>

<div class="card">
    <h2>Validação do Modelo: Nota Real vs. Nota Prevista</h2>
    <p>
        Este gráfico plota a nota real do aluno (Eixo Y) contra a nota que o
        modelo "adivinhou" (Eixo X). (Amostra de 2000 alunos)
    </p>
    <div id="scatter-chart" class="plotly-chart-div"></div>
</div>

<script>
    var data_importance = {{ ml_data_importance|tojson }};
    var data_scatter = {{ ml_data_scatter|tojson }};

    // --- Gráfico 1: Importância (Barras) ---
    var trace_importance = {
        x: data_importance.importance,
        y: data_importance.features,
        type: 'bar',
        orientation: 'h',
        marker: { color: '#3b82f6' }
    };
    var layout_importance = {
        template: 'plotly_dark',
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: 'white'},
        title: data_importance.titulo,
        xaxis: {title: 'Nível de Importância (Soma total = 1.0)'},
        yaxis: {
            title: 'Fator de Análise',
            categoryorder: 'total ascending',
            automargin: true
        },
        responsive: true
    };
    Plotly.newPlot('importance-chart', [trace_importance], layout_importance, {responsive: true});

    // --- Gráfico 2: Dispersão (Scatter) ---
    var trace_scatter = {
        x: data_scatter.previsto,
        y: data_scatter.real,
        mode: 'markers',
        type: 'scatter',
        marker: { 
            color: '#3b82f6',
            opacity: 0.5
        }
    };
    var layout_scatter = {
        template: 'plotly_dark',
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: 'white'},
        title: 'Nota Real vs. Nota Prevista',
        xaxis: {title: 'Nota PREVISTA'},
        yaxis: {title: 'Nota REAL'},
        margin: { l: 50, r: 20, t: 50, b: 50 },
        responsive: true
    };
    Plotly.newPlot('scatter-chart', [trace_scatter], layout_scatter, {responsive: true});

</script>

{% endblock %}